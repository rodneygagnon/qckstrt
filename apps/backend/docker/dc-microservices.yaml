
x-apps-config: &apps-env
  PROJECT: ${PROJECT:-qckstrt}
  NODE_ENV: ${NODE_ENV:-dev}
  AWS_PROFILE: ${AWS_PROFILE:-default}
  AWS_REGION: ${AWS_REGION:-us-west-2}
  AWS_SECRETS: ${AWS_SECRETS}

x-api-config: &api-env
  <<: *apps-env
  APPLICATION: ${API_APPLICATION}
  VERSION: ${API_VERSION}
  DESCRIPTION: ${API_DESCRIPTION}
  MICROSERVICES: ${API_MICROSERVICES}
  PORT: 8080

x-users-config: &users-env
  <<: *apps-env
  APPLICATION: ${USERS_APPLICATION}
  VERSION: ${USERS_VERSION}
  DESCRIPTION: ${USERS_DESCRIPTION}
  PORT: 8080

x-files-config: &files-env
  <<: *apps-env
  APPLICATION: ${FILES_APPLICATION}
  VERSION: ${FILES_VERSION}
  DESCRIPTION: ${FILES_DESCRIPTION}
  PORT: 8080

x-vectors-config: &vectors-env
  <<: *apps-env
  APPLICATION: ${VECTORS_APPLICATION}
  VERSION: ${VECTORS_VERSION}
  DESCRIPTION: ${VECTORS_DESCRIPTION}
  PORT: 8080
  CHROMA_URL: http://chromadb:8000

networks:
  backend:
    name: ${PROJECT}-${NODE_ENV}-backend
    external: false

services:
  api:
    build:
      context: ..
      platforms:
        - "linux/amd64"
      dockerfile: docker/Dockerfile.${API_APPLICATION}
    image: ${PROJECT}-${NODE_ENV}-${API_APPLICATION}:latest
    container_name: nestjs-${API_APPLICATION}
    platform: "linux/amd64"
    environment:
      <<: *api-env
    networks:
      - backend
    volumes:
      - ~/.aws/:/root/.aws:ro
    ports:
      - "${API_PORT}:8080"
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
  users:
    build:
      context: ..
      platforms:
        - "linux/amd64"
      dockerfile: docker/Dockerfile.${USERS_APPLICATION}
    image: ${PROJECT}-${NODE_ENV}-${USERS_APPLICATION}:latest
    container_name: nestjs-${USERS_APPLICATION}
    platform: "linux/amd64"
    environment:
      <<: *users-env
    networks:
      - backend
    volumes:
      - ~/.aws/:/root/.aws:ro
    ports:
      - "${USERS_PORT}:8080"
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
  files:
    build:
      context: ..
      platforms:
        - "linux/amd64"
      dockerfile: docker/Dockerfile.${FILES_APPLICATION}
    image: ${PROJECT}-${NODE_ENV}-${FILES_APPLICATION}:latest
    container_name: nestjs-${FILES_APPLICATION}
    platform: "linux/amd64"
    environment:
      <<: *files-env
    networks:
      - backend
    volumes:
      - ~/.aws/:/root/.aws:ro
    ports:
      - "${FILES_PORT}:8080"
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
  vectors:
    build:
      context: ..
      platforms:
        - "linux/amd64"
      dockerfile: docker/Dockerfile.${VECTORS_APPLICATION}
    image: ${PROJECT}-${NODE_ENV}-${VECTORS_APPLICATION}:latest
    container_name: nestjs-${VECTORS_APPLICATION}
    platform: "linux/amd64"
    environment:
      <<: *vectors-env
    networks:
      - backend
    volumes:
      - ~/.aws/:/root/.aws:ro
    ports:
      - "${VECTORS_PORT}:8080"
    restart: always
    depends_on:
      - chromadb

  postgres:
    image: postgres:16-alpine
    container_name: qckstrt-postgres
    platform: "linux/amd64"
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-qckstrt}
      POSTGRES_USER: ${POSTGRES_USER:-qckstrt_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-qckstrt_password}
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-qckstrt_user} -d ${POSTGRES_DB:-qckstrt}"]
      interval: 10s
      timeout: 5s
      retries: 5

  chromadb:
    image: chromadb/chroma:latest
    container_name: qckstrt-chromadb
    platform: "linux/amd64"
    ports:
      - "8000:8000"
    volumes:
      - chroma-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=FALSE
    networks:
      - backend
    restart: unless-stopped

volumes:
  postgres-data:
    name: qckstrt-postgres-data
  chroma-data:
    name: qckstrt-chroma-data
